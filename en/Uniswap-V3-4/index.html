<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an web3 blog..."/>
  <meta name="keyword" content="web3,blockchain,smart contract,solidity"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/en/Uniswap-V3-4/">
  <title>
    
      Uniswap V3 详解（四）：Oracle 预言机 - Live My Life
    
  </title>
<meta name="generator" content="Hexo 7.2.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Live My Life</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Uniswap V3" title="Uniswap V3">Uniswap V3</a>
              
            </div>
            <h1>Uniswap V3 详解（四）：Oracle 预言机</h1>
            <h2 class="subheading">...</h2>
            <span class="meta">
              Posted by Mr. Alex on
              2023-08-23
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">15</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.8k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2 id="Uniswap-v3-的预言机"><a href="#Uniswap-v3-的预言机" class="headerlink" title="Uniswap v3 的预言机"></a>Uniswap v3 的预言机</h2><p>Uniswap v3版本针对v2版本Oracle的痛点，进行了改进：</p>
<ul>
<li>合约中默认还是存储一个最近价格的时间积累，但是可以根据需要，扩展最近N个历史价格的时间积累值，最多支持65535个最近历史价格信息，这样第三方开发者不在需要自己实现合约<br>存储历史信息</li>
<li><p>Oracle中不光记录了价格信息，还记录了对应流动性的时间积累值，因为V3中相同交易对在不同费率时不同的交易池，这样在使用Oracle时， 可以选择流动性较大的池作为价格参考来源</p>
</li>
<li><p>Uniswap v2中可以计算出时间加权平均值（算数平均值），而v3中计算出来的是时间加权几何平均值，团队称几何平均值币算数平均值更合适，</p>
</li>
</ul>
<h3 id="为什么使用几何平均值"><a href="#为什么使用几何平均值" class="headerlink" title="为什么使用几何平均值"></a>为什么使用几何平均值</h3><p>算数平均值的优势是其简单性，也符合直觉的平均数，相当于计算算术平均数的数据系列越长，其算数平均值就有越高的几率接近期望值，这种现象在统计学中被称为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B">[大数法则]</a></p>
<p>几何平均数一般来说都会小于算数平均数，但是对于波动较大的数字而言，使用几何平均数，其波动性的影响会更小。</p>
<p>具体到Uniswap项目中：</p>
<ul>
<li>从工程实现角度看</li>
<li>合约中使用tick index来表示价格区间，存储tick index的时间加权累计值，使得Oracle的实现更为简单直接，避免了在存储Oracle数据过程中进行指数计算，在计算式可以更节省gas</li>
<li>在 v2 版本中，需要对 token0 和 token1 的 Oracle 分别进行存储（因为价格的算术平均数并不是互为倒数的）。而 v3 使用了几何平均数，token0 和 token1 的价格的几何平均数互为倒数，这样合约只存储代币对中一个代币的的 Oracle 值即可，在存储时也更加节省 gas 费用</li>
<li>从金融数学角度看</li>
<li>交易对价格的走势可以通过 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%87%A0%E4%BD%95%E5%B8%83%E6%9C%97%E8%BF%90%E5%8A%A8">几何布朗运动</a> 模型化，在几何布朗运动中算术平均数，会给予高价格更高的权重，平均价格更容易受到波动性的影响。</li>
</ul>
<h2 id="攻击成本"><a href="#攻击成本" class="headerlink" title="攻击成本"></a>攻击成本</h2><p>一个攻击者在攻击代币对Oracle时，为了成本最小化，通常会采用一下策略：</p>
<ul>
<li>攻击者在同一个区块中，在Oracle写入的前后买入再卖出某种资产，以实现低成本操纵Oracle数据的目的。</li>
</ul>
<h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><p>Uniswap V3沿用了v2版本中的设计，以增加对Oracle攻击的成本，具体如下：</p>
<ul>
<li>在同一个区块内，Oracle的写入操作只会发生这个区块中的第一笔价格发生了改变的交易中。</li>
<li>在写入Oracle时，写入的并不是本次交易结束时的价格，而是交易前的价格，即上一次交易的最终价格，又因为第一条的原因，这样实际上在更新本次Oracle数据时，使用的<br>是上一次交易所在区块中最后一个交易的价格</li>
</ul>
<p>这样做之后：</p>
<ul>
<li>攻击者无法在一个区块中 完成对Oracle数据的操纵，只能分多笔交易跨区块才有可能实现Oracle数据的操纵</li>
<li>多笔跨区块的交易还必须要发生在对饮区块的末尾和起始交易，这样实现也是很难。</li>
</ul>
<p>这些限制无疑增加了攻击者对代币对进行攻击的成本，使得低成本攻击变得困难。</p>
<p>当然，随着flashbots/MiningDAO 之类工具的流行，这种攻击也不是不可能实现，但是这是另外的话题了，不在本文的讨论范围。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>Oracle实现的代码都在uniswap-v3-core的合约实现中，Oracle相关的操作主要在以下情况下发生：</p>
<ul>
<li>初始交易池时，初始化Oracle，但是此时Oracle中只有一个槽位，即只保存最近的一份数据</li>
<li>发生交易时，价格会变动，此时需要更新Oracle</li>
<li>外部开发者可以调用接口获取历史Oracle数据，计算出TWAP</li>
<li>对交易历史Oracle数据由需求开发者可以调用交易池提供的接口扩展Oracle数据存储的数量。</li>
</ul>
<h3 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h3><p>Oracle数据使用一个结构体 <code>Observation</code> 来表示：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct Observation &#123;<br>    // 记录区块的时间戳<br>    uint32 blockTimestamp;<br>    // tick index 的时间加权累积值<br>    int56 tickCumulative;<br>    // 价格所在区间的流动性的时间加权累积值<br>    uint160 liquidityCumulative;<br>    // 是否已经被初始化<br>    bool initialized;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>在交易池的合约中，使用一个数组来存储交易池最近的Oracle数据：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract UniswapV3Pool is IUniswapV3Pool, NoDelegateCall &#123;<br>    ...<br>    // Oracle 相关操作的库<br>    using Oracle for Oracle.Observation[65535];<br>    ...<br>    // 使用数据记录 Oracle 的值<br>    Oracle.Observation[65535] public override observations;<br>    ...<br>    struct Slot0 &#123;<br>        ...<br>        // 记录了最近一次 Oracle 记录在 Oracle 数组中的索引位置<br>        uint16 observationIndex;<br>        // 已经存储的 Oracle 数量<br>        uint16 observationCardinality;<br>        // 可用的 Oracle 空间，此值初始时会被设置为 1，后续根据需要来可以扩展<br>        uint16 observationCardinalityNext;<br>    &#125;<br>    Slot0 public override slot0;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>数组的大小为65535，但实际上在初始化阶段这个数据并不会被全部使用，而仅使用其中一部分空间（初始为1）。</p>
<p>当第三方对某个交易池的Oracle数据有需求时，可以主动调用合约的扩展接口扩展这个数据的可用空间，这样后续合约会存储更新的Oracle数据</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>在之前创建交易对的文章中说过，创建交易对时，<code>UniswapV3Factory</code> 会调用创建交易对<code>UniswapPool.initlize()</code>函数对合约进行初始化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function initialize(uint160 sqrtPriceX96) external override &#123;<br>    ...<br><br>    // 初始化 Oracle<br>    (uint16 cardinality, uint16 cardinalityNext) = observations.initialize(_blockTimestamp());<br><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在初始化的代码中，调用了<code>observation.initialize(_blockTimestamp())</code>来进行Oracle的初始化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function initialize(Observation[65535] storage self, uint32 time)<br>internal<br>returns (uint16 cardinality, uint16 cardinalityNext)<br>&#123;<br>self[0] = Observation(&#123;blockTimestamp: time, tickCumulative: 0, liquidityCumulative: 0, initialized: true&#125;);<br>// 返回当前 Oracle 的个数和最大可用个数<br>return (1, 1);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到初始化就是写入一个空值Oracle数据，并且返回了当前的Oracle的个数和最大可用个数，最大可用个数<code>cardinalityNext</code>为1，表示合约初始化时，只会记录最近1次的Oracle数据</p>
<h3 id="Oracle更新"><a href="#Oracle更新" class="headerlink" title="Oracle更新"></a>Oracle更新</h3><p>Oracle数据的更新发生在价格变动的时候，前文说过，为了防止攻击，同一个区块内，只会在第一次发生价格变动事写入Oracle信息。在<code>UniswapV3Pool.swap()</code><br>函数中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// 检查价格是否发生了变化，当价格变化时，需要写入一个 Oracle 数据<br>if (state.tick != slot0Start.tick) &#123;<br>    // 写入 Oracle 数据<br>    (uint16 observationIndex, uint16 observationCardinality) =<br>        observations.write(<br>            // 交易前的最新 Oracle 索引<br>            slot0Start.observationIndex,<br>            // 当前区块的时间<br>            cache.blockTimestamp,<br>            // 交易前的价格的 tick ，如前文所述，这样做是为了防止攻击<br>            slot0Start.tick,<br>            // 交易前的价格对应的流动性<br>            cache.liquidityStart,<br>            // 当前的 Oracle 数量<br>            slot0Start.observationCardinality,<br>            // 可用的 Oracle 数量<br>            slot0Start.observationCardinalityNext<br>        );<br>    // 更新最新 Oracle 指向的索引信息以及当前 Oracle 数据的总数目<br>    (slot0.sqrtPriceX96, slot0.tick, slot0.observationIndex, slot0.observationCardinality) = (<br>        state.sqrtPriceX96,<br>        state.tick,<br>        observationIndex,<br>        observationCardinality<br>    );<br>&#125; else &#123;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里首先检查价格是否发生了变化，当价格变化时，需要写入Oracle数据，调用的是<code>observations.write</code>函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function write(<br>    Observation[65535] storage self,<br>    uint16 index,<br>    uint32 blockTimestamp,<br>    int24 tick,<br>    uint128 liquidity,<br>    uint16 cardinality,<br>    uint16 cardinalityNext<br>) internal returns (uint16 indexUpdated, uint16 cardinalityUpdated) &#123;<br>    // 获取当前的 Oracle 数据<br>    Observation memory last = self[index];<br><br>    // 如前文所述，同一个区块内，只会在第一笔交易中写入 Oracle 数据<br>    if (last.blockTimestamp == blockTimestamp) return (index, cardinality);<br><br>    // 检查是否需要使用新的数组空间<br>    if (cardinalityNext &gt; cardinality &amp;&amp; index == (cardinality - 1)) &#123;<br>        cardinalityUpdated = cardinalityNext;<br>    &#125; else &#123;<br>        cardinalityUpdated = cardinality;<br>    &#125;<br><br>    // 本次写入的索引，使用余数实现 ring buffer<br>    indexUpdated = (index + 1) % cardinalityUpdated;<br>    // 写入 Oracle 数据<br>    self[indexUpdated] = transform(last, blockTimestamp, tick, liquidity);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>写入时会计算出需要使用的索引数，如果可用空间用满会重新从头开始写入，Oracle数据使用<code>tansform</code>函数生成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function transform(<br>    Observation memory last,<br>    uint32 blockTimestamp,<br>    int24 tick,<br>    uint128 liquidity<br>) private pure returns (Observation memory) &#123;<br>    // 上次 Oracle 数据和本次的时间差<br>    uint32 delta = blockTimestamp - last.blockTimestamp;<br>    return<br>        Observation(&#123;<br>            blockTimestamp: blockTimestamp,<br>            // 计算 tick index 的时间加权累积值<br>            tickCumulative: last.tickCumulative + int56(tick) * delta,<br>            // 计算时间加权累积值<br>            liquidityCumulative: last.liquidityCumulative + uint160(liquidity) * delta,<br>            initialized: true<br>        &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这样就完成了一次Oracle的写入。</p>
<h3 id="Oracle的使用"><a href="#Oracle的使用" class="headerlink" title="Oracle的使用"></a>Oracle的使用</h3><p>第三方开发者要使用Oracle，调用交易池的<code>UniswapV3Pool.observe()</code>函数即可：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function observe(uint32[] calldata secondsAgos)<br>    external<br>    view<br>    override<br>    noDelegateCall<br>    returns (int56[] memory tickCumulatives, uint160[] memory liquidityCumulatives)<br>&#123;<br>    return<br>        observations.observe(<br>            _blockTimestamp(),<br>            secondsAgos,<br>            slot0.tick,<br>            slot0.observationIndex,<br>            liquidity,<br>            slot0.observationCardinality<br>        );<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>传入的参数<code>secondAgos</code>是一个动态数组，顾名思义表示请求N秒前的数据，使用数组可以一次请求多个历史数据。返回的<code>tickCumulatives</code>和<code>liquidityCumulatives</code><br>也是动态数组，记录了请求参数中对应时间戳的tick index累计值和流动性累计值，数据的处理在<code>observations.observe()</code>完成的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function observe(<br>    Observation[65535] storage self,<br>    uint32 time,<br>    uint32[] memory secondsAgos,<br>    int24 tick,<br>    uint16 index,<br>    uint128 liquidity,<br>    uint16 cardinality<br>) internal view returns (int56[] memory tickCumulatives, uint160[] memory liquidityCumulatives) &#123;<br>    require(cardinality &gt; 0, &#x27;I&#x27;);<br><br>    tickCumulatives = new int56[](secondsAgos.length);<br>    liquidityCumulatives = new uint160[](secondsAgos.length);<br>    // 遍历传入的时间参数，获取结果<br>    for (uint256 i = 0; i &lt; secondsAgos.length; i++) &#123;<br>        (tickCumulatives[i], liquidityCumulatives[i]) = observeSingle(<br>            self,<br>            time,<br>            secondsAgos[i],<br>            tick,<br>            index,<br>            liquidity,<br>            cardinality<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这个函数就是通过遍历请求参数，获取每一个请求时间点的Oracle数据，具体数据通过<code>observeSingle()</code>函数来获取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function observeSingle(<br>    Observation[65535] storage self,<br>    uint32 time,<br>    uint32 secondsAgo,<br>    int24 tick,<br>    uint16 index,<br>    uint128 liquidity,<br>    uint16 cardinality<br>) private view returns (int56 tickCumulative, uint160 liquidityCumulative) &#123;<br>    // secondsAgo 为 0 表示当前的最新 Oracle 数据<br>    if (secondsAgo == 0) &#123;<br>        Observation memory last = self[index];<br>        if (last.blockTimestamp != time) last = transform(last, time, tick, liquidity);<br>        return (last.tickCumulative, last.liquidityCumulative);<br>    &#125;<br><br>    // 计算出请求的时间戳<br>    uint32 target = time - secondsAgo;<br><br>    // 计算出请求时间戳最近的两个 Oracle 数据<br>    (Observation memory beforeOrAt, Observation memory atOrAfter) =<br>        getSurroundingObservations(self, time, target, tick, index, liquidity, cardinality);<br><br>    Oracle.Observation memory at;<br>    // 如果请求时间和返回的左侧时间戳吻合，那么可以直接使用<br>    if (target == beforeOrAt.blockTimestamp) &#123;<br>        at = beforeOrAt;<br>    // 如果请求时间和返回的右侧时间戳吻合，那么可以直接使用<br>    &#125; else if (target == atOrAfter.blockTimestamp) &#123;<br>        at = atOrAfter;<br>    &#125; else &#123;<br>        // 当请请求的时间在中间时，计算根据增长率计算出请求的时间点的 Oracle 值并返回<br>        uint32 delta = atOrAfter.blockTimestamp - beforeOrAt.blockTimestamp;<br>        int24 tickDerived = int24((atOrAfter.tickCumulative - beforeOrAt.tickCumulative) / delta);<br>        uint128 liquidityDerived =<br>            uint128((atOrAfter.liquidityCumulative - beforeOrAt.liquidityCumulative) / delta);<br>        at = transform(beforeOrAt, target, tickDerived, liquidityDerived);<br>    &#125;<br><br>    return (at.tickCumulative, at.liquidityCumulative);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在这函数中，会先调用<code>getSurroundingObservations()</code>找出的时间点前后，最近的两个Oracle数据，然后通过时间差的比较就算出需要返回的数据：</p>
<ul>
<li>如果和其中的某一个的时间戳相等，那么就可以直接返回</li>
<li>如果在两个时间点的中间，那么通过计算增长率的方式，计算出请求时间点的Oracle数据并返回</li>
</ul>
<p><code>getSurroundingObservations()</code>函数的作用是在已记录的Oracle数组中，找到时间戳离其最近的两个Oracle数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function getSurroundingObservations(<br>    Observation[65535] storage self,<br>    uint32 time,<br>    uint32 target,<br>    int24 tick,<br>    uint16 index,<br>    uint128 liquidity,<br>    uint16 cardinality<br>) private view returns (Observation memory beforeOrAt, Observation memory atOrAfter) &#123;<br>    // 先把 beforeOrAt 设置为当前最新数据<br>    beforeOrAt = self[index];<br><br>    // 检查 beforeOrAt 是否 &lt;= target<br>    if (lte(time, beforeOrAt.blockTimestamp, target)) &#123;<br>        if (beforeOrAt.blockTimestamp == target) &#123;<br>            // 如果时间戳相等，那么可以忽略 atOrAfter 直接返回<br>            return (beforeOrAt, atOrAfter);<br>        &#125; else &#123;<br>            // 当前区块中发生代币对的交易之前请求此函数时可能会发生这种情况<br>            // 需要将当前还未持久化的数据，封装成一个 Oracle 数据返回，<br>            return (beforeOrAt, transform(beforeOrAt, target, tick, liquidity));<br>        &#125;<br>    &#125;<br><br>    // 将 beforeOrAt 调整至 Oracle 数组中最老的数据<br>    // 即为当前 index 的下一个数据，或者 index 为 0 的数据<br>    beforeOrAt = self[(index + 1) % cardinality];<br>    if (!beforeOrAt.initialized) beforeOrAt = self[0];<br><br>    // ensure that the target is chronologically at or after the oldest observation<br>    require(lte(time, beforeOrAt.blockTimestamp, target), &#x27;OLD&#x27;);<br><br>    // 然后通过二分查找的方式找到离目标时间点最近的前后两个 Oracle 数据<br>    return binarySearch(self, time, target, index, cardinality);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这个函数会调用 <code>binarySearch()</code> 通过二分查找的方式，找到目标离目标时间点最近的前后两个 Oracle 数据，其中的具体实现这里就不再描述了。</p>
<p>最终，<code>UniswapV3Pool.observe()</code>将会返回请求者所请求的每一个时间点的 Oracle 数据，请求者可以根据这些数据计算出交易对的 TWAP（时间加权平均价，几何平均数），计算公式在前文。</p>
<p>同时因为 Oracle 数据中还包含了流动性的时间累积值，还可以计算出交易池在一段时间内的 TWAL（时间加权平均流动性，算是平均数）。</p>
<h3 id="Oracle-数组扩容"><a href="#Oracle-数组扩容" class="headerlink" title="Oracle 数组扩容"></a>Oracle 数组扩容</h3><p>之前说过，虽然合约定义了 Oracle 使用 65535 长度的数组，但是并不会在一开始就使用这么多的空间，这样做是因为：</p>
<ul>
<li>向空数组中写入 Oracle 数据是比较昂贵的操作（SSTORE）</li>
<li>写入 Oracle 数据的操作发生在交易的操作中</li>
<li>这些操作如果由交易者负担，是不公平的，因为代币交易者并不一定是 Oracle 的使用者</li>
</ul>
<p>因此 Uniswap v3 在初始时 Oracle 数组仅可以写入一个数据，这个是通过交易池合约的 <code>slot0.observationCardinalityNext</code>变量控制的。</p>
<p>当初始设置不满足需求时，合约提供了单独接口，让对 Oracle 历史数据有需求的开发者，自行调用接口来扩展交易池 Oracle 中存储数据的上限。这样就将 Oracle 数组存储空间初始化操作的 gas 费转移到了 Oracle 的需求方，而不是由代币交易者承担。</p>
<p>通过 <code>increaseObservationCardinalityNext()</code> 可以扩展交易池的 Oracle 数组可用容量，传入的参数为期望存储的历史数据个数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function increaseObservationCardinalityNext(uint16 observationCardinalityNext)<br>    external<br>    override<br>    lock<br>    noDelegateCall<br>&#123;<br>    uint16 observationCardinalityNextOld = slot0.observationCardinalityNext; // for the event<br>    uint16 observationCardinalityNextNew =<br>        observations.grow(observationCardinalityNextOld, observationCardinalityNext);<br>    slot0.observationCardinalityNext = observationCardinalityNextNew;<br>    if (observationCardinalityNextOld != observationCardinalityNextNew)<br>        emit IncreaseObservationCardinalityNext(observationCardinalityNextOld, observationCardinalityNextNew);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这个函数调用了 <code>observations.grow()</code> 完成底层存储空间的初始化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function grow(<br>    Observation[65535] storage self,<br>    uint16 current,<br>    uint16 next<br>) internal returns (uint16) &#123;<br>    require(current &gt; 0, &#x27;I&#x27;);<br>    // no-op if the passed next value isn&#x27;t greater than the current next value<br>    if (next &lt;= current) return current;<br>    // 对数组中将来可能会用到的槽位进行写入，以初始化其空间，避免在 swap 中初始化<br>    for (uint16 i = current; i &lt; next; i++) self[i].blockTimestamp = 1;<br>    return next;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里可以看到，通过循环的方式，将 Oracle 数组中未来可能被使用的空间中写入数据。这样做的目的是将数据进行初始化，这样在代币交易写入新的 Oracle 数据时，不需要再进行初始化，可以让交易时更新 Oracle 不至于花费太多的 gas，SSTORE 指令由 20000 降至 5000。<br>可以参考：<a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-1087">EIP-1087</a> ,<br><a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-2200">EIP-2200</a> ,<br><a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-2929">EIP-2929</a> ，<br>具体实现：<a target="_blank" rel="noopener" href="https://github.com/ethereum/go-ethereum/blob/8fe47b0a0d4280020c246fee817a87e358f868f3/core/vm/gas_table.go#L96-L218">core/vm/gas_table.go</a> 。</p>
<p>至此，关于 Uniswap v3 Oracle 的所有操作就介绍完毕了。</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/Contract_Report/" data-toggle="tooltip" data-placement="top" title="智能合约中常见的漏洞和优化Gas">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/Uniswap-V3-3/" data-toggle="tooltip" data-placement="top" title="Uniswap V3 详解（三）：交易过程">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Uniswap V3 详解（四）：Oracle 预言机&body=Hi,I found this website and thought you might like it http://yoursite-url/en/Uniswap-V3-4/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '8d34cec04e51a507b217',
      clientSecret: 'dbd95dbedb6676efc06c083311491ed110f98fd5',
      repo: 'openskyx.github.io',
      owner: 'OpenSkyX',
      admin: 'OpenSkyX',
      id: 'Wed Aug 23 2023 18:36:17 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Uniswap-v3-%E7%9A%84%E9%A2%84%E8%A8%80%E6%9C%BA"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Uniswap v3 的预言机</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%87%A0%E4%BD%95%E5%B9%B3%E5%9D%87%E5%80%BC"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">为什么使用几何平均值</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%94%BB%E5%87%BB%E6%88%90%E6%9C%AC"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">攻击成本</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">防御措施</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">代码实现</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">存储</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">初始化</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Oracle%E6%9B%B4%E6%96%B0"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">Oracle更新</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Oracle%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">Oracle的使用</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Oracle-%E6%95%B0%E7%BB%84%E6%89%A9%E5%AE%B9"><span class="toc-nav-number">3.5.</span> <span class="toc-nav-text">Oracle 数组扩容</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Uniswap V3" title="Uniswap V3">Uniswap V3</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/OpenSkyX">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://twitter.com/XMaxio">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Mr. Alex
          2024
          <br>
          <!-- Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe> -->
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
