<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an web3 blog..."/>
  <meta name="keyword" content="web3,blockchain,smart contract,solidity"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/en/Uniswap-V1/">
  <title>
    
      Uniswap V1 深度解析并兼容Solidity 0.8版本 - Live My Life
    
  </title>
<meta name="generator" content="Hexo 7.2.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Live My Life</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Uniswap V1" title="Uniswap V1">Uniswap V1</a>
              
            </div>
            <h1>Uniswap V1 深度解析并兼容Solidity 0.8版本</h1>
            <h2 class="subheading">uniswap 是一个去中心化交易所协议，而乘积做市是一种流动性提供策略，用于在去中心化交易所中为资产配对提供流动性。</h2>
            <span class="meta">
              Posted by Mr. Alex on
              2022-08-21
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">13</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.7k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <blockquote>
<p>Uniswap 是一个去中心化交易所协议，而乘积做市是一种流动性提供策略，用于在去中心化交易所中为资产配对提供流动性。</p>
<ul>
<li><p>乘积做市是一种常见的做市策略，它与传统的常数做市（Constant Product Market Making）策略（Uniswap 最早采用的策略）不同。在乘积做市中，做市商会通过为交易对提供资产，使得它们的乘积保持不变。这意味着，当一个交易发生时，交易对中的两种资产数量的乘积保持恒定，从而形成了一个超越线性关系的交易价格曲线。</p>
</li>
<li><p>这种策略的一个重要特点是，在价格接近某一端的时候，交易价格会呈指数级地变化，这在一定程度上能够提供更好的价格敏感性。然而，乘积做市也存在一些挑战，包括对大额交易的抵抗力不足，以及需要在资产价格剧烈波动时频繁调整做市池。</p>
</li>
<li><p>如果您想要了解更多关于 Uniswap 和乘积做市策略的信息，我建议您查阅 Uniswap 官方文档、论坛以及相关的加密货币和区块链资源，以获得更深入的了解。请注意，加密货币领域的技术和概念可能会不断发展和变化，因此最好参考最新的资料。</p>
</li>
</ul>
</blockquote>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><blockquote>
<p>Uniswap V1 源代码 <a target="_blank" rel="noopener" href="https://github.com/Uniswap/old-solidity-contracts">点这儿</a></p>
<p>本文中将用Solidity 0.8版本进行版本兼容</p>
<p>开发环境 IDEA， foundry，Hardhat，Solidity ^0.8</p>
</blockquote>
<h3 id="创建一个新项目并forge初始化"><a href="#创建一个新项目并forge初始化" class="headerlink" title="创建一个新项目并forge初始化"></a>创建一个新项目并forge初始化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir UniswapV1<br>cd UniswapV1<br>forge init<br></code></pre></td></tr></table></figure>
<h4 id="forge-安装测试openzeppelin-和forge-std-库"><a href="#forge-安装测试openzeppelin-和forge-std-库" class="headerlink" title="forge 安装测试openzeppelin 和forge-std 库"></a>forge 安装测试openzeppelin 和forge-std 库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">forge install @openzeppelin-contracts<br>forge install forge-std <br></code></pre></td></tr></table></figure>
<h4 id="在src目录下创建-interface文件夹"><a href="#在src目录下创建-interface文件夹" class="headerlink" title="在src目录下创建 interface文件夹"></a>在src目录下创建 interface文件夹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir  interface<br></code></pre></td></tr></table></figure>
<h4 id="编写工厂合约接口"><a href="#编写工厂合约接口" class="headerlink" title="编写工厂合约接口"></a>编写工厂合约接口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.8.21;<br><br>interface IUniswapFactory &#123;<br>    //根据token地址创建交易对<br>    function launchExchange(address _token) external returns (address exchange);      <br>    //查询交易对数量<br>    function getExchangeCount() external view returns (uint exchangeCount);<br>    //根据token地址查询交易对合约地址<br>    function tokenToExchangeLookup(address _token) external view returns (address exchange);<br>    // 根据交易对地址查询token地址<br>    function exchangeToTokenLookup(address _exchange) external view returns (address token);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="编写交易对合约接口"><a href="#编写交易对合约接口" class="headerlink" title="编写交易对合约接口"></a>编写交易对合约接口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.21;<br>interface IUniSwapExchange&#123;<br>    //过去交易对ETH交易池数量<br>    function ethPool() external returns(uint256);<br>    //获取交易对token交易池数量<br>    function tokenPool() external returns(uint256);<br>    // 获取乘积做市的值    K = x * y  此方法获取的是K值<br>    function invariant() external returns(uint256);<br>    // 查询总共提供的流动性值<br>    function totalShares() external returns(uint256);<br>    // 获取token 代币地址<br>    function tokenAddress() external returns(address);<br>    // 获取工厂合约地址<br>    function factoryAddress() external returns(address);<br>    // 初始化交易对  根据传入的以太坊数量和token数量计算 乘积做市K值<br>    function initializeExchange(uint256 _tokenAmount)external payable;<br>    //用ETH来兑换token<br>    function ethToTokenSwap(uint256 _minTokens) external payable;<br>    //用token来兑换ETH<br>    function tokenToEthSwap(uint256 _tokenAmount, uint256 _minEth ) external;<br>    //提供流动性<br>    function investLiquidity(uint256 _minShares) external payable;<br>    //移除流动性<br>    function divestLiquidity(uint256 _sharesBurned, uint256 _minEth, uint256 _minTokens) external;<br>    //获取当前用户提供的流动性<br>    function getShares(address _provider) external view returns(uint256 _shares);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="编写交易对合约"><a href="#编写交易对合约" class="headerlink" title="编写交易对合约"></a>编写交易对合约</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.8.21;<br>import &#123;SafeMath&#125; from &quot;@openzeppelin-contracts/contracts/utils/math/SafeMath.sol&quot;;<br>import &#123;IERC20&#125; from &quot;@openzeppelin-contracts/contracts/token/ERC20/IERC20.sol&quot;;<br>import &#123;IUniswapFactory&#125; from &quot;./interface/IUniswapFactory.sol&quot;;<br>import &#123;IUniSwapExchange&#125; from &quot;./interface/IUniSwapExchange.sol&quot;;<br><br><br>contract UniSwapExchange &#123;<br>    using SafeMath for uint256;<br><br>    event EthToTokenPurchase(address indexed buyer,uint256 indexed ethIn,uint256 indexed tokensOut);  //Eth 購買token事件通知<br>    event TokenToEthPurchase(address indexed buyer,uint256 indexed tokensIn,uint256 indexed ethOut);  //token 兌換 ETH事件通知<br>    event Investment(address indexed liquidityProvider, uint256 indexed sharesPurchase);              //添加流動性事件通知<br>    event Divestment(address indexed liquidityProvider, uint256 indexed sharesBurned);                //移除流動性事件通知<br>    event InitializeExchange(address indexed token,uint256 indexed initializeAmount);<br><br>    uint256 constant FEE_RATE  = 500;            //0.2% 費率<br><br>    uint256 public ethPool;<br>    uint256 public tokenPool;<br>    uint256 public invariant;<br>    uint256 public totalShares;<br>    address public tokenAddress;<br>    address public factoryAddress;<br><br>    mapping(address =&gt; uint256) shares;<br><br>    IERC20 token;<br>    IUniswapFactory factory;<br><br><br>    modifier exchangeInitialized()&#123;<br>        require(invariant &gt; 0 &amp;&amp; totalShares &gt; 0);<br>        _;<br>    &#125;<br><br>    constructor(address _tokenAddress)&#123;<br>        tokenAddress = _tokenAddress;<br>        factoryAddress = msg.sender;<br>        token = IERC20(tokenAddress);<br>        factory = IUniswapFactory(factoryAddress);<br>    &#125;<br><br>    receive() payable external&#123;<br>        require(msg.value != 0);<br>        //TODO<br>        ethToToken(msg.sender, msg.sender, msg.value, 1);<br>    &#125;<br><br>    //初始化交易对<br>    function initializeExchange(uint256 _tokenAmount)external payable&#123;<br>        require(invariant == 0 &amp;&amp; totalShares == 0);<br>        require(msg.value &gt;= 10000 &amp;&amp; _tokenAmount &gt;= 10000 &amp;&amp; msg.value &lt;= 5 * 10 ** 18);<br><br>        ethPool = msg.value;<br>        tokenPool = _tokenAmount;<br>        invariant = ethPool.mul(tokenPool);<br>        shares[msg.sender] = 1000;<br>        totalShares = 1000;<br>        emit InitializeExchange(tokenAddress,_tokenAmount);<br>        require(token.transferFrom(payable(msg.sender),address(this),_tokenAmount),&quot;transfer fail!&quot;);<br>    &#125;<br><br>    function ethToTokenSwap(uint256 _minTokens) external payable&#123;<br>        require(msg.value &gt; 0 &amp;&amp; _minTokens &gt; 0);<br>        ethToToken(msg.sender,msg.sender,msg.value,_minTokens);<br>    &#125;<br><br>    function ethToTokenPayment(uint256 _minTokens, address _recipient) external payable &#123;<br>        require(_minTokens &gt; 0 &amp;&amp; _recipient != address(0) &amp;&amp; _recipient != address(this));<br>        ethToToken(msg.sender,_recipient,msg.value,_minTokens);<br>    &#125;<br><br>    function tokenToEthSwap(uint256 _tokenAmount, uint256 _minEth ) external &#123;<br>        require(_tokenAmount &gt; 0 &amp;&amp; _minEth &gt; 0);<br>        tokenToEth(msg.sender,msg.sender,_tokenAmount,_minEth);<br>    &#125;<br><br>    function tokenToEthPayment(uint256 _tokenAmount ,uint256 _minEth ,address _recipient) external payable&#123;<br>        require(_tokenAmount &gt; 0 &amp;&amp; _minEth &gt; 0 &amp;&amp; _recipient != address(0) &amp;&amp; _recipient != address(this));<br>        tokenToEth(msg.sender,_recipient,_tokenAmount,_minEth);<br>    &#125;<br><br>    function tokenToTokenSwap(address _tokenPurchased,address _recipient,uint256 _tokensSold,uint256 _minTokensReceived) external &#123;<br>        require(_tokenPurchased != address(0) &amp;&amp; _recipient != address(0) &amp;&amp; _recipient != address(this) &amp;&amp; _tokensSold &gt; 0 &amp;&amp; _minTokensReceived &gt; 0);<br>        tokenToTokenOut(_tokenPurchased,msg.sender,_recipient,_tokensSold,_minTokensReceived);<br>    &#125;<br><br>    function tokenTokenIn(address _recipient,uint256 _minTokens) external payable returns(bool)&#123;<br>        require(_minTokens &gt; 0);<br>        address exchangeToken = factory.exchangeToTokenLookup(msg.sender);<br>        require(exchangeToken != address(0));<br>        ethToToken(msg.sender,_recipient, msg.value,_minTokens);<br>        return true;<br>    &#125;<br><br>    function investLiquidity(uint256 _minShares) external payable exchangeInitialized&#123;<br>        require(msg.value &gt; 0 &amp;&amp; _minShares &gt; 0,&quot;msg.value = 0 &amp;&amp; _minShares = 0&quot;);<br>        uint256 ethPerShare = ethPool.div(totalShares);<br>        require(msg.value &gt;= ethPerShare,&quot;msg.value &lt; ethPerShare&quot;);<br>        uint256 sharesPurchased = msg.value.div(ethPerShare);<br>        require(sharesPurchased &gt;= _minShares,&quot;sharesPurchased &lt; _minShares&quot;);<br>        uint256 tokensPerShare = tokenPool.div(totalShares);<br>        uint256 tokensRequired = sharesPurchased.mul(tokensPerShare);<br>        shares[msg.sender] = shares[msg.sender].add(sharesPurchased);<br>        totalShares = totalShares.add(sharesPurchased);<br>        ethPool = ethPool.add(msg.value);<br>        tokenPool = tokenPool.add(tokensRequired);<br>        invariant = ethPool.mul(tokenPool);<br>        emit Investment(msg.sender, sharesPurchased);<br>        require(token.transferFrom(msg.sender, address(this), tokensRequired),&quot;Test Fail&quot;);<br>    &#125;<br><br>    function divestLiquidity(<br>        uint256 _sharesBurned,<br>        uint256 _minEth,<br>        uint256 _minTokens<br>    )<br>    external<br>    &#123;<br>        require(_sharesBurned &gt; 0);<br>        shares[msg.sender] = shares[msg.sender].sub(_sharesBurned);<br>        uint256 ethPerShare = ethPool.div(totalShares);<br>        uint256 tokensPerShare = tokenPool.div(totalShares);<br>        uint256 ethDivested = ethPerShare.mul(_sharesBurned);<br>        uint256 tokensDivested = tokensPerShare.mul(_sharesBurned);<br>        require(ethDivested &gt;= _minEth &amp;&amp; tokensDivested &gt;= _minTokens);<br>        totalShares = totalShares.sub(_sharesBurned);<br>        ethPool = ethPool.sub(ethDivested);<br>        tokenPool = tokenPool.sub(tokensDivested);<br>        if (totalShares == 0) &#123;<br>            invariant = 0;<br>        &#125; else &#123;<br>            invariant = ethPool.mul(tokenPool);<br>        &#125;<br>        emit Divestment(msg.sender, _sharesBurned);<br>        require(token.transfer(msg.sender, tokensDivested));<br>        payable(msg.sender).transfer(ethDivested);<br>    &#125;<br><br>    // View share balance of an address<br>    function getShares(<br>        address _provider<br>    )<br>    external<br>    view<br>    returns(uint256 _shares)<br>    &#123;<br>        return shares[_provider];<br>    &#125;<br><br>    function ethToToken(address buyer,address recipient,uint256 ethIn,uint256 mintTokensOut) internal exchangeInitialized&#123;<br><br>        uint256 fee = ethIn.div(FEE_RATE);                                 //计算费率<br>        uint256 newEthPool = ethPool.add(ethIn);                           //计算交易对中最新的ETH流动性总量<br>        uint256 tempEthPool = newEthPool.sub(fee);                         //减去费率后最新流动池中ETH数量<br>        uint256 newTokenPool = invariant.div(tempEthPool);                 //公式 x * y = k  那最新的tokenPool  y = k / x      10000 = 10 * 1000   10000 / 12 = 833<br><br>        uint256 tokensOut = tokenPool.sub(newTokenPool);                   // 为了保持始终 x * y = k  之前的流动池数量 - 重新计算的流动池数量 = 本次买入的token数量<br><br>        require(tokensOut &gt;= mintTokensOut &amp;&amp; tokensOut &lt;= tokenPool);<br><br>        ethPool = newEthPool;                                               // 更新流动性信息<br>        tokenPool = newTokenPool;<br>        invariant = newEthPool.mul(newTokenPool);                           //计算新的k值<br><br>        emit EthToTokenPurchase(buyer,ethIn,tokensOut);<br><br>        require(token.transfer(recipient,tokensOut));<br>    &#125;<br><br><br>    function tokenToEth(address buyer,address recipient,uint256 tokensIn,uint256 minEthOut) internal exchangeInitialized &#123;<br><br>        uint256 fee = tokensIn.div(FEE_RATE);<br>        uint256 newTokenPool = tokenPool.add(tokensIn);<br>        uint256 tempTokenPool =  newTokenPool.sub(fee);<br>        uint256 newEthPool = invariant.div(tempTokenPool);<br><br>        uint256 ethOut = ethPool.sub(newEthPool);<br>        require(ethOut &gt;= minEthOut &amp;&amp; ethOut &lt;= ethPool);<br>        tokenPool = newTokenPool;<br>        ethPool = newEthPool;<br>        invariant = newEthPool.mul(newTokenPool);<br>        emit TokenToEthPurchase(buyer,tokensIn,ethOut);<br>        require(token.transferFrom(buyer,address(this),tokensIn),&quot;transfer token fail&quot;);<br><br>        payable(recipient).transfer(ethOut);<br>    &#125;<br><br>    function tokenToTokenOut(address tokenPurchased ,address buyer ,address recipient ,uint256 tokensIn,  uint256 minTokensOut) internal exchangeInitialized&#123;<br><br>        require(tokenPurchased != address(0) &amp;&amp; tokenPurchased != address(this));<br>        address exchangeAddress = factory.tokenToExchangeLookup(tokenPurchased);<br>        require(exchangeAddress != address(0) &amp;&amp; exchangeAddress != address(this));<br><br>        uint256 fee = tokensIn.div(FEE_RATE);<br>        uint256 newTokenPool = tokenPool.add(tokensIn);<br>        uint256 tempTokenPool = newTokenPool.sub(fee);<br>        uint256 newEthPool = invariant.div(tempTokenPool);<br>        uint256 ethOut = ethPool.sub(newEthPool);<br>        require(ethOut &lt;= ethPool);<br>        IUniSwapExchange exchange = IUniSwapExchange(exchangeAddress);<br><br>        emit TokenToEthPurchase(buyer,tokensIn,ethOut);<br>        tokenPool = newTokenPool;<br>        ethPool = newEthPool;<br>        invariant = ethPool.mul(tokenPool);<br><br>        require(token.transferFrom(buyer,address(this),tokensIn));<br>        require(exchange.tokenToTokenIn&#123;value:ethOut&#125;(recipient,minTokensOut));<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="编写工厂合约"><a href="#编写工厂合约" class="headerlink" title="编写工厂合约"></a>编写工厂合约</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: UNLICENSED<br>pragma solidity ^0.8.21;<br>import &#123;UniSwapExchange&#125; from &quot;./UniSwapExchange.sol&quot;;<br><br>contract UniswapFactory&#123;<br><br>    address[] public tokenList;<br>    mapping(address =&gt; address) tokenToExchange;<br>    mapping(address =&gt; address) exchangeToToken;<br><br>    event ExchangeLaunch(address indexed exchange, address indexed token);<br><br>    function launchExchange(address _token) public returns (address exchange) &#123;<br>        require(tokenToExchange[_token] == address(0));             //There can only be one exchange per token<br>        require(_token != address(0) &amp;&amp; _token != address(this));<br>        UniSwapExchange newExchange = new UniSwapExchange(_token);<br>        tokenList.push(_token);<br>        tokenToExchange[_token] = address(newExchange);<br>        exchangeToToken[address(newExchange)] = _token;<br>        emit ExchangeLaunch(address(newExchange), _token);<br>        return address(newExchange);<br>    &#125;<br><br><br>    function getExchangeCount() public view returns (uint exchangeCount) &#123;<br>        return tokenList.length;<br>    &#125;<br><br>    function tokenToExchangeLookup(address _token) public view returns (address exchange) &#123;<br>        return tokenToExchange[_token];<br>    &#125;<br><br>    function exchangeToTokenLookup(address _exchange) public view returns (address token) &#123;<br>        return exchangeToToken[_exchange];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>最初版本的UniSwap核心就只有交易对合约和工厂合约，功能也非常简单，就是用以太坊去兑换币，其核心是乘积做市</p>
<ul>
<li><p>价格敏感性： 乘积做市策略使得交易价格在接近某一端时呈指数级变化，这意味着在价格变动较小的区间内，交易价格会更为敏感。这可以在市场价格波动较小时提供更好的定价。</p>
</li>
<li><p>降低滑点： 由于乘积做市策略的特性，它在价格接近池子的一端时交易价格变化较快。这可以减少交易中的滑点（买卖价格差异），使交易更加准确。</p>
</li>
<li><p>激励做市商： 乘积做市可以激励更多的做市商参与，因为他们可以在价格变动较小时也有机会获得利润。这有助于增加交易对的流动性，从而提高交易体验。</p>
</li>
<li><p>适应不同市场条件： 乘积做市在不同市场条件下表现良好，无论市场是处于相对稳定还是高度波动的状态。它的价格曲线形状使其能够在多种市场环境下进行有效的价格定价。</p>
</li>
<li><p>支持更多资产： 乘积做市策略相对灵活，可以支持不同类型的资产对。这意味着可以用于各种加密货币和数字资产的交易对。</p>
</li>
<li><p>去中心化： 乘积做市策略在去中心化交易所中使用，与传统的中心化交易所不同，用户可以在不需要信任中心化机构的情况下进行交易和提供流动性。</p>
</li>
</ul>
</blockquote>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">forge build<br></code></pre></td></tr></table></figure>
<p>控制台输出：<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">[⠰] Compiling...<br>[⠒] Compiling 1 files with 0.8.21<br>[⠑] Solc 0.8.21 finished in 2.26s<br>Compiler run successful!<br></code></pre></td></tr></table></figure><br>编译成功</p>
<h3 id="Test-测试编写"><a href="#Test-测试编写" class="headerlink" title="Test 测试编写"></a>Test 测试编写</h3><p>在foundry Test目录下编写，Test测试文件以 <code>.t.sol</code> 结尾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.8.13;<br><br>import &#123;Test, console2&#125; from &quot;forge-std/Test.sol&quot;;<br>import &#123;TestToken&#125; from &quot;../../src/ERC20/ERC20Token.sol&quot;;<br>import &#123;UniswapFactory&#125; from &quot;../../src/UniswapFactory.sol&quot;;<br>import &#123;UniSwapExchange&#125; from &quot;../../src/UniSwapExchange.sol&quot;;<br>import &#123;IUniSwapExchange&#125; from &quot;../../src/interface/IUniSwapExchange.sol&quot;;<br><br><br>contract UniswapFactoryTest is Test &#123;<br>    TestToken public token;<br>    UniswapFactory public factory;<br><br>    //运行Test之前先部署Test token合约和工厂合约<br>    function setUp() public &#123;<br>        token = new TestToken();<br>        factory = new UniswapFactory();<br>    &#125;<br><br>    function test_swap() public &#123;<br>        //首先创建交易对<br>        address exchangeAddress = factory.launchExchange(address(token));<br>        // 加在交易对接口合约<br>        IUniSwapExchange exchange = IUniSwapExchange(exchangeAddress);<br>        // 授权token给交易对合约地址 10万token<br>        token.approve(exchangeAddress,100000 ether);<br>        // 初始化token  1以太坊和10万token  为初始比例<br>        exchange.initializeExchange&#123;value: 1 ether&#125;(100000 ether);<br>        // 使用ETH购买token 传入1 ETH，预期获取49900 代币，实际获取49949.949949949949949950 <br>        exchange.ethToTokenSwap&#123;value: 1 ether&#125;(49900 ether); //49949.949949949949949950<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>uinswap V1 是特别适合新学Solidity的开发者，代码简洁，代码量少，易理解。</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/Hardhat-zksync-deploy/" data-toggle="tooltip" data-placement="top" title="Zksync Era 使用Hardhat部署只能合约">&larr; Previous Post</a>
          </li>
          
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Uniswap V1 深度解析并兼容Solidity 0.8版本&body=Hi,I found this website and thought you might like it http://yoursite-url/en/Uniswap-V1/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '8d34cec04e51a507b217',
      clientSecret: 'dbd95dbedb6676efc06c083311491ed110f98fd5',
      repo: 'openskyx.github.io',
      owner: 'OpenSkyX',
      admin: 'OpenSkyX',
      id: 'Sun Aug 21 2022 14:39:17 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">快速开始</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%B9%B6forge%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">创建一个新项目并forge初始化</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#forge-%E5%AE%89%E8%A3%85%E6%B5%8B%E8%AF%95openzeppelin-%E5%92%8Cforge-std-%E5%BA%93"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">forge 安装测试openzeppelin 和forge-std 库</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%9C%A8src%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%88%9B%E5%BB%BA-interface%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">在src目录下创建 interface文件夹</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BC%96%E5%86%99%E5%B7%A5%E5%8E%82%E5%90%88%E7%BA%A6%E6%8E%A5%E5%8F%A3"><span class="toc-nav-number">1.1.3.</span> <span class="toc-nav-text">编写工厂合约接口</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BC%96%E5%86%99%E4%BA%A4%E6%98%93%E5%AF%B9%E5%90%88%E7%BA%A6%E6%8E%A5%E5%8F%A3"><span class="toc-nav-number">1.1.4.</span> <span class="toc-nav-text">编写交易对合约接口</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BC%96%E5%86%99%E4%BA%A4%E6%98%93%E5%AF%B9%E5%90%88%E7%BA%A6"><span class="toc-nav-number">1.1.5.</span> <span class="toc-nav-text">编写交易对合约</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BC%96%E5%86%99%E5%B7%A5%E5%8E%82%E5%90%88%E7%BA%A6"><span class="toc-nav-number">1.1.6.</span> <span class="toc-nav-text">编写工厂合约</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%96%E8%AF%91"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">编译</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Test-%E6%B5%8B%E8%AF%95%E7%BC%96%E5%86%99"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">Test 测试编写</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Uniswap V1" title="Uniswap V1">Uniswap V1</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/OpenSkyX">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://twitter.com/XMaxio">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Mr. Alex
          2024
          <br>
          <!-- Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe> -->
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
